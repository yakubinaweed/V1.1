title: "VeritasRI Analysis Report" author: "VeritasRI Application" output: pdf_document: toc: false number_sections: false params: tab_name: "" analysis_time: null download_time: null inputs: null outputs: null plot_fn: null plot_bic_fn: null plot_clustered_fn: null get_summary_fn: null
library(shiny)
library(ggplot2)
library(dplyr)
library(mclust)
library(refineR)
library(rmarkdown)
library(sysfonts)
library(showtext)
library(car)

# Ensure fonts are available for rendering
# This is wrapped in tryCatch to prevent errors in environments without internet access
tryCatch({
  showtext_auto()
  font_add_google("Inter", "inter")
  font_add_google("Rethink Sans", "rethink_sans")
}, error = function(e) {
  message("Error loading Google Fonts: ", e$message)
  message("Proceeding with default fonts.")
})

\pagenumbering{gobble}
\begin{center}

r params$tab_name Report
\end{center}

\vspace{0.5cm}
\begin{flushright}
Analysis Date: r format(params$analysis_time, "%Y-%m-%d")
\newline
Analysis Time: r format(params$analysis_time, "%H:%M:%S")
\newline
\vspace{0.2cm}
Report Download Date: r format(params$download_time, "%Y-%m-%d")
\newline
Report Download Time: r format(params$download_time, "%H:%M:%S")
\end{flushright}
\vspace{1cm}

\section*{User Inputs}
\begin{itemize}
\item \textbf{Data File:} r if(!is.null(params$inputs$file_name)) params$inputs$file_name else "N/A"
\item \textbf{Value Column:} r params$inputs$value_col
\item \textbf{Age Column:} r params$inputs$age_col
\item \textbf{Gender Column:} r if(is.null(params$inputs$gender_col) || params$inputs$gender_col == "") "Not Selected" else params$inputs$gender_col
\item \textbf{Unit of Measurement:} r if(is.null(params$inputs$unit) || params$inputs$unit == "") "Not specified" else params$inputs$unit
\item \textbf{Number of Bootstraps:} r params$inputs$nbootstrap
\item \textbf{Transformation Model:} r params$inputs$model_choice

if (params$tab_name == "Main Analysis") {

\item \textbf{Gender Choice:} `r params$inputs$gender_choice`
\item \textbf{Age Range:} `r paste(params$inputs$age_range[1], "to", params$inputs$age_range[2], "years")`
\item \textbf{Reference Lower Limit:} `r if(is.na(params$inputs$ref_low)) "Not specified" else params$inputs$ref_low`
\item \textbf{Reference Upper Limit:} `r if(is.na(params$inputs$ref_high)) "Not specified" else params$inputs$ref_high`

}

if (params$tab_name == "Subpopulation Detection (GMM)") {

\item \textbf{Gender Analysis:} `r params$inputs$gender_choice`
\item \textbf{Model Selection:} `r params$inputs$model_selection_choice`

  if(params$inputs$model_selection_choice == "Manual Selection") {

\item \textbf{Selected Model:} `r params$inputs$manual_model`
\item \textbf{Component Number:} `r params$inputs$component_number`

  }
}

if (params$tab_name == "Parallel Analysis") {

\item \textbf{Male Age Ranges:} `r if(is.null(params$inputs$male_ranges) || params$inputs$male_ranges == "") "Not specified" else params$inputs$male_ranges`
\item \textbf{Female Age Ranges:} `r if(is.null(params$inputs$female_ranges) || params$inputs$female_ranges == "") "Not specified" else params$inputs$female_ranges`
\item \textbf{Combined Age Ranges:} `r if(is.null(params$inputs$combined_ranges) || params$inputs$combined_ranges == "") "Not specified" else params$inputs$combined_ranges`
\item \textbf{Number of Cores:} `r params$inputs$cores`

}

\end{itemize}

\newpage
\section*{Analysis Results}

r if(!is.null(params$outputs$removed_rows)) {
\noindent\textbf{Note:} r params$outputs$removed_rows rows were removed due to missing or invalid data.
}

\vspace{0.5cm}

if(params$tab_name == "Main Analysis") {

Main Analysis Plot
params$plot_fn()

\newpage

Analysis Summary
print(params$outputs$model)

}

if(params$tab_name == "Subpopulation Detection (GMM)") {

  if(!is.null(params$models$combined) || !is.null(params$models$male) || !is.null(params$models$female)) {

### BIC Criterion Plots
```{r gmm-bic-plot, fig.width=8, fig.height=5, echo=FALSE}
params$plot_bic_fn()
```
\newpage
### Clustered Data Plot
```{r gmm-clustered-plot, fig.width=8, fig.height=6, echo=FALSE}
params$plot_clustered_fn()
```

\newpage
### Analysis Summary
```{r gmm-summary, echo=FALSE, results="asis"}
if (!is.null(params$models$combined)) {
  cat("--- Combined Subpopulations ---\n")
  print(summary(params$models$combined))
}

if (!is.null(params$models$male)) {
  cat("--- Male Subpopulations ---\n")
  print(summary(params$models$male))
}

if (!is.null(params$models$female)) {
  cat("--- Female Subpopulations ---\n")
  print(summary(params$models$female))
}
```

  }
}

if(params$tab_name == "Parallel Analysis") {

  if(!is.null(params$outputs$combined_summary) && nrow(params$outputs$combined_summary) > 0) {

Combined Summary Table
print(params$outputs$combined_summary %>% select(-label, -age_min, -age_max))

\newpage

Estimated Reference Intervals by Subpopulation

# Replicate the plot logic from server_parallel.R
plot_data_summary <- params$outputs$combined_summary

unit_label <- if (!is.null(params$inputs$unit) && params$inputs$unit != "") {
    paste0(params$inputs$value_col, " [", params$inputs$unit, "]")
} else {
    params$inputs$value_col
}

gender_colors <- c("Male" = "steelblue", "Female" = "darkred", "Combined" = "darkgreen")

plot_data_summary$label <- factor(plot_data_summary$label,
                                   levels = unique(plot_data_summary$label[order(plot_data_summary$Gender, plot_data_summary$age_min)]))

ggplot(plot_data_summary, aes(y = label)) +
  geom_segment(aes(x = `CI Lower (Lower)`,
                    xend = `CI Lower (Upper)`,
                    y = label,
                    yend = label,
                    color = Gender),
              linewidth = 10, alpha = 0.3, lineend = "square") +
  geom_segment(aes(x = `CI Upper (Lower)`,
                    xend = `CI Upper (Upper)`,
                    y = label,
                    yend = label,
                    color = Gender),
              linewidth = 10, alpha = 0.3, lineend = "square") +
  geom_errorbarh(aes(xmin = `RI Lower`,
                      xmax = `RI Upper`,
                      color = Gender),
                  height = 0.1, linewidth = 1.2) +
  geom_point(aes(x = `RI Lower`, color = Gender), shape = 18, size = 4) +
  geom_point(aes(x = `RI Upper`, color = Gender), shape = 18, size = 4) +
  labs(title = "Estimated Reference Intervals by Subpopulation",
       x = unit_label, y = NULL, color = "Gender") +
  scale_color_manual(values = gender_colors, name = "Gender") +
  scale_fill_manual(values = gender_colors, guide = "none") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
    axis.title.x = element_text(size = 14, margin = margin(t = 10)),
    axis.text = element_text(size = 12),
    legend.title = element_text(size = 12, face = "bold"),
    legend.text = element_text(size = 10)
  )


\newpage

Reference Intervals by Age and Gender
plot_data_summary <- params$outputs$combined_summary

unit_label <- if (!is.null(params$inputs$unit) && params$inputs$unit != "") {
    paste0(params$inputs$value_col, " [", params$inputs$unit, "]")
} else {
    params$inputs$value_col
}

gender_colors <- c("Male" = "steelblue", "Female" = "darkred", "Combined" = "darkgreen")

ggplot(plot_data_summary) +
    geom_rect(aes(xmin = age_min, xmax = age_max, ymin = `CI Lower (Lower)`, ymax = `CI Lower (Upper)`, fill = Gender), alpha = 0.2) +
    geom_rect(aes(xmin = age_min, xmax = age_max, ymin = `CI Upper (Lower)`, ymax = `CI Upper (Upper)`, fill = Gender), alpha = 0.2) +
    geom_segment(aes(x = age_min, xend = age_max, y = `RI Lower`, yend = `RI Lower`, color = Gender), linewidth = 1.2, linetype = "solid") +
    geom_segment(aes(x = age_min, xend = age_max, y = `RI Upper`, yend = `RI Upper`, color = Gender), linewidth = 1.2, linetype = "solid") +
    geom_point(aes(x = age_min, y = `RI Lower`, color = Gender), size = 2) +
    geom_point(aes(x = age_max, y = `RI Lower`, color = Gender), size = 2) +
    geom_point(aes(x = age_min, y = `RI Upper`, color = Gender), size = 2) +
    geom_point(aes(x = age_max, y = `RI Upper`, color = Gender), size = 2) +
    labs(title = "Reference Intervals by Age and Gender",
         x = "Age", y = unit_label, color = "Gender", fill = "Gender (95% CI)") +
    scale_x_continuous(limits = c(0, 120)) +
    scale_color_manual(values = gender_colors) +
    scale_fill_manual(values = gender_colors, guide = "none") +
    theme_minimal() +
    theme(
      plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
      axis.title = element_text(size = 14),
      axis.text = element_text(size = 12),
      legend.title = element_text(size = 12, face = "bold"),
      legend.text = element_text(size = 10),
      legend.position = "bottom"
    )

\newpage

Faceted Density Plot by Subpopulation
plot_data <- params$outputs$raw_data
results <- params$outputs$results

if (nrow(plot_data) > 0) {
  req(params$outputs$gender_filter)
  plot_data <- plot_data %>% filter(Gender_Standardized %in% params$outputs$gender_filter)
  
  unit_label <- if (!is.null(params$inputs$unit) && params$inputs$unit != "") {
    paste0(params$inputs$value_col, " [", params$inputs$unit, "]")
  } else {
    params$inputs$value_col
  }
  
  ri_lines <- tibble()
  for (result in results) {
    if (result$status == "success") {
      ri_lines <- bind_rows(ri_lines, tibble(
        label = result$label,
        ri_low = result$ri_low_fulldata,
        ri_high = result$ri_high_fulldata
      ))
    }
  }
  ri_lines <- ri_lines %>% filter(str_extract(label, "^\\w+") %in% params$outputs$gender_filter)

  custom_colors <- c("Male" = "steelblue", "Female" = "darkred", "Combined" = "darkgreen")
  fill_colors <- setNames(custom_colors[str_extract(unique(plot_data$label), "^\\w+")], unique(plot_data$label))

  ggplot(plot_data, aes(x = Value, fill = label)) +
    geom_density(alpha = 0.6) +
    geom_vline(data = ri_lines, aes(xintercept = ri_low), linetype = "dashed", color = "darkred", size = 1) +
    geom_vline(data = ri_lines, aes(xintercept = ri_high), linetype = "dashed", color = "darkred", size = 1) +
    facet_wrap(~label, scales = "free_y") +
    labs(title = "Faceted Density Plot by Subpopulation", x = unit_label, y = "Density", fill = "Subpopulation") +
    scale_fill_manual(values = fill_colors) +
    theme_minimal() +
    theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
          strip.text = element_text(size = 12), axis.title = element_text(size = 14),
          axis.text = element_text(size = 12), legend.title = element_text(size = 12, face = "bold"),
          legend.text = element_text(size = 10), legend.position = "bottom")
}

\newpage

Box Plot of Value Distribution by Subpopulation
plot_data <- params$outputs$raw_data

if(nrow(plot_data) > 0) {
  req(params$outputs$gender_filter)
  plot_data <- plot_data %>% filter(Gender_Standardized %in% params$outputs$gender_filter)
  
  male_labels <- plot_data %>% dplyr::filter(grepl("Male", label)) %>% dplyr::arrange(label) %>% dplyr::pull(label) %>% unique()
  female_labels <- plot_data %>% dplyr::filter(grepl("Female", label)) %>% dplyr::arrange(label) %>% dplyr::pull(label) %>% unique()
  combined_labels <- plot_data %>% dplyr::filter(grepl("Combined", label)) %>% dplyr::arrange(label) %>% dplyr::pull(label) %>% unique()
  custom_order <- c(male_labels, female_labels, combined_labels)
  remaining_labels <- setdiff(unique(plot_data$label), custom_order)
  if(length(remaining_labels) > 0) {
      custom_order <- c(custom_order, remaining_labels)
  }
  plot_data$label <- factor(plot_data$label, levels = custom_order)

  unit_label <- if (!is.null(params$inputs$unit) && params$inputs$unit != "") {
    paste0(params$inputs$value_col, " [", params$inputs$unit, "]")
  } else {
    params$inputs$value_col
  }
  
  custom_colors <- c("Male" = "steelblue", "Female" = "darkred", "Combined" = "darkgreen")
  fill_colors <- setNames(custom_colors[str_extract(unique(plot_data$label), "^\\w+")], unique(plot_data$label))

  ggplot(plot_data, aes(x = label, y = Value, fill = label)) +
    geom_boxplot(alpha = 0.7, outlier.colour = "red", outlier.shape = 8) +
    labs(title = "Summary of Value Distribution by Subpopulation", x = "Subpopulation", y = unit_label, fill = "Subpopulation") +
    coord_flip() +
    scale_fill_manual(values = fill_colors) +
    theme_minimal() +
    theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
          axis.title = element_text(size = 14), axis.text = element_text(size = 12),
          legend.title = element_text(size = 12, face = "bold"), legend.text = element_text(size = 10))
}

  }
}

\vspace{1cm}

\begin{center}
\textit{End of Report}
\end{center}